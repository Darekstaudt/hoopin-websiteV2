<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1e2d">
  <title>Create Team - Hoopin'</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/animations.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <button class="btn btn-icon" data-action="back" aria-label="Go back">
        â† Back
      </button>
      <div class="logo">ğŸ€ Hoopin'</div>
      <div style="width: 44px;"></div>
    </div>
  </header>

  <div class="container">
    <div class="form-container page-transition">
      <div class="form-card">
        <h1 class="text-center">Create Team</h1>
        <p class="text-center" style="color: var(--text-secondary); margin-bottom: 2rem;">
          Set up your basketball team
        </p>

        <form id="createTeamForm" onsubmit="handleSubmit(event)">
          <!-- Team Name -->
          <div class="form-group required">
            <label for="teamName">Team Name</label>
            <input 
              type="text" 
              id="teamName" 
              name="teamName" 
              placeholder="e.g., Lakers"
              required
              maxlength="50"
            >
          </div>

          <!-- Manager Name -->
          <div class="form-group required">
            <label for="manager">Manager Name</label>
            <input 
              type="text" 
              id="manager" 
              name="manager" 
              placeholder="Your name"
              required
              maxlength="50"
            >
          </div>

          <!-- Team Photo -->
          <div class="form-group">
            <label for="teamPhoto">Team Photo (Optional)</label>
            <div class="file-upload">
              <input type="file" id="teamPhoto" accept="image/*" onchange="handlePhotoUpload(event)">
              <div class="file-upload-label">
                <span>ğŸ“· Upload Team Photo</span>
              </div>
            </div>
            <div class="file-preview" id="photoPreview">
              <img id="photoPreviewImg" alt="Team photo preview">
            </div>
          </div>

          <input type="hidden" id="teamPhotoData" name="teamPhotoData">

          <!-- Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="navigateToPage('dashboard.html')">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              Create Team
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Autosave Indicator -->
  <div class="autosave-indicator" id="autosaveIndicator"></div>

  <!-- Scripts -->
  <script src="js/firebase-config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/performance.js"></script>
  <script src="js/image-optimizer.js"></script>
  <script src="js/db-manager.js"></script>
  <script src="js/groups.js"></script>
  <script src="js/teams.js"></script>
  <script src="js/app.js"></script>

  <script>
    let teamPhotoBase64 = '';
    let isEditing = false;
    let editingTeamId = null;

    // Check group access
    if (!checkGroupAccess()) {
      // Will redirect
    }

    async function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      try {
        showLoading('Processing image...');
        const compressed = await imageOptimizer.compressImage(file);
        hideLoading();

        teamPhotoBase64 = compressed;
        document.getElementById('teamPhotoData').value = compressed;
        
        const preview = document.getElementById('photoPreview');
        const previewImg = document.getElementById('photoPreviewImg');
        previewImg.src = compressed;
        preview.classList.add('show');

        const size = imageOptimizer.getImageSize(compressed);
        showToast(`Image compressed: ${size}`, 'success');
      } catch (error) {
        hideLoading();
        console.error('Image upload error:', error);
        showToast('Failed to process image', 'error');
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const form = document.getElementById('createTeamForm');
      const formData = new FormData(form);
      
      const currentGroup = groupManager.getCurrentGroup();
      if (!currentGroup) {
        showToast('No group selected', 'error');
        return;
      }

      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = isEditing ? 'Updating...' : 'Creating...';
      showLoading(isEditing ? 'Updating team...' : 'Creating team...');
      
      try {
        const teamData = {
          teamName: formData.get('teamName'),
          manager: formData.get('manager'),
          teamPhoto: teamPhotoBase64,
          groupId: currentGroup.groupId
        };

        let result;
        if (isEditing) {
          result = await teamManager.updateTeam(editingTeamId, teamData);
        } else {
          result = await teamManager.createTeam(teamData);
        }
        
        hideLoading();
        
        if (result.success) {
          showToast(isEditing ? 'Team updated!' : 'Team created!', 'success');
          session.remove('teamDraft');
          
          setTimeout(() => {
            navigateToPage('dashboard.html');
          }, 1000);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        hideLoading();
        console.error('Submit error:', error);
        showToast(error.message || 'Failed to save team', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = isEditing ? 'Update Team' : 'Create Team';
      }
    }

    // Auto-save draft
    const autosaveDraft = debounce(() => {
      const form = document.getElementById('createTeamForm');
      const formData = new FormData(form);
      const draft = {
        teamName: formData.get('teamName'),
        manager: formData.get('manager'),
        teamPhoto: teamPhotoBase64
      };
      session.set('teamDraft', draft);
      
      const indicator = document.getElementById('autosaveIndicator');
      indicator.textContent = 'ğŸ’¾ Draft saved';
      indicator.className = 'autosave-indicator saved show';
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }, 1000);

    // Load draft or editing team
    window.addEventListener('load', async () => {
      setupCommonElements();
      
      const params = getQueryParams();
      const currentGroup = groupManager.getCurrentGroup();
      
      if (params.teamId) {
        // Editing mode
        isEditing = true;
        editingTeamId = params.teamId;
        document.querySelector('h1').textContent = 'Edit Team';
        document.getElementById('submitBtn').textContent = 'Update Team';
        
        showLoading('Loading team...');
        const team = await teamManager.getTeam(editingTeamId);
        hideLoading();
        
        if (team) {
          document.getElementById('teamName').value = team.teamName;
          document.getElementById('manager').value = team.manager;
          
          if (team.teamPhoto) {
            teamPhotoBase64 = team.teamPhoto;
            document.getElementById('teamPhotoData').value = team.teamPhoto;
            const preview = document.getElementById('photoPreview');
            const previewImg = document.getElementById('photoPreviewImg');
            previewImg.src = team.teamPhoto;
            preview.classList.add('show');
          }
        }
      } else {
        // Creating mode - load draft
        const draft = session.get('teamDraft');
        if (draft) {
          document.getElementById('teamName').value = draft.teamName || '';
          document.getElementById('manager').value = draft.manager || '';
          
          if (draft.teamPhoto) {
            teamPhotoBase64 = draft.teamPhoto;
            const preview = document.getElementById('photoPreview');
            const previewImg = document.getElementById('photoPreviewImg');
            previewImg.src = draft.teamPhoto;
            preview.classList.add('show');
          }
        } else if (currentGroup) {
          // Pre-fill with group creator
          document.getElementById('manager').value = currentGroup.creator;
        }
      }

      // Setup autosave
      const inputs = document.querySelectorAll('input[type="text"]');
      inputs.forEach(input => {
        input.addEventListener('input', autosaveDraft);
      });
    });
  </script>
</body>
</html>
