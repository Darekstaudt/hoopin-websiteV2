<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1e2d">
  <title>Team Roster - Hoopin'</title>
  
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/divisions.css">
  <link rel="stylesheet" href="css/animations.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <button class="btn btn-icon" data-action="back">‚Üê Back</button>
      <div class="logo">üèÄ <span id="teamNameHeader"></span></div>
      <button class="btn btn-icon" onclick="showTeamMenu()">‚ãÆ</button>
    </div>
  </header>

  <div class="container page-transition">
    <!-- Team Header -->
    <div class="card" style="margin-top: 1rem;">
      <div style="display: flex; gap: 1rem; align-items: center;">
        <div id="teamPhotoContainer"></div>
        <div style="flex: 1;">
          <h2 style="margin: 0 0 0.5rem 0;" id="teamName"></h2>
          <p style="margin: 0; color: var(--text-secondary);" id="teamManager"></p>
          <div id="teamDivision" style="margin-top: 0.5rem;"></div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 1rem;">
        <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: var(--radius-md);">
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="totalPlayers">0</div>
          <div style="font-size: 0.75rem; color: var(--text-muted);">Players</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: var(--radius-md);">
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="avgOverall">0</div>
          <div style="font-size: 0.75rem; color: var(--text-muted);">Avg OVR</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: var(--radius-md);">
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="startersCount">0</div>
          <div style="font-size: 0.75rem; color: var(--text-muted);">Starters</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: var(--radius-md);">
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="benchCount">0</div>
          <div style="font-size: 0.75rem; color: var(--text-muted);">Bench</div>
        </div>
      </div>
    </div>

    <!-- Starters -->
    <h3 style="margin: 2rem 0 1rem 0;">Starting 5</h3>
    <div class="player-cards-scroll" id="startersContainer"></div>

    <!-- Bench -->
    <h3 style="margin: 2rem 0 1rem 0;">Bench</h3>
    <div class="player-cards-scroll" id="benchContainer"></div>
  </div>

  <button class="fab" onclick="addPlayer()" aria-label="Add player">‚ûï</button>

  <script src="js/firebase-config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/performance.js"></script>
  <script src="js/db-manager.js"></script>
  <script src="js/ratings.js"></script>
  <script src="js/groups.js"></script>
  <script src="js/teams.js"></script>
  <script src="js/players.js"></script>
  <script src="js/divisions.js"></script>
  <script src="js/app.js"></script>

  <script>
    let teamId = null;
    let currentTeam = null;
    let draggedElement = null;
    let draggedPlayerId = null;
    let draggedContainer = null;
    let touchDragging = false;
    let touchStartX = 0;
    let touchStartY = 0;
    let touchElement = null;
    let longPressTimer = null;

    async function loadTeamRoster() {
      if (!teamId) return;

      showLoading('Loading roster...');

      try {
        currentTeam = await teamManager.getTeam(teamId);
        const { starters, bench } = await teamManager.getTeamRoster(teamId);
        const stats = await teamManager.getTeamStats(teamId);
        const division = await divisionManager.calculateTeamDivision(teamId);

        hideLoading();

        if (!currentTeam) {
          showToast('Team not found', 'error');
          return;
        }

        document.getElementById('teamNameHeader').textContent = currentTeam.teamName;
        document.getElementById('teamName').textContent = currentTeam.teamName;
        document.getElementById('teamManager').textContent = `Manager: ${currentTeam.manager}`;
        
        const photoContainer = document.getElementById('teamPhotoContainer');
        if (currentTeam.teamPhoto) {
          photoContainer.innerHTML = `<img src="${currentTeam.teamPhoto}" style="width: 80px; height: 80px; border-radius: var(--radius-lg); object-fit: cover;">`;
        } else {
          photoContainer.innerHTML = '<div style="width: 80px; height: 80px; background: var(--secondary-bg); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üèÄ</div>';
        }

        document.getElementById('teamDivision').innerHTML = divisionManager.createDivisionBadge(division.name, 'small');

        document.getElementById('totalPlayers').textContent = stats.totalPlayers;
        document.getElementById('avgOverall').textContent = stats.avgOverall;
        document.getElementById('startersCount').textContent = `${stats.startersCount}/5`;
        document.getElementById('benchCount').textContent = stats.benchCount;

        renderPlayers('startersContainer', starters, 'No starters yet');
        renderPlayers('benchContainer', bench, 'No bench players yet');
      } catch (error) {
        hideLoading();
        console.error('Load roster error:', error);
        showToast('Failed to load roster', 'error');
      }
    }

    function renderPlayers(containerId, players, emptyMessage) {
      const container = document.getElementById(containerId);
      
      if (players.length === 0) {
        container.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--text-muted);">${emptyMessage}</div>`;
        return;
      }

      container.innerHTML = '';
      
      players.forEach((player, index) => {
        const card = document.createElement('div');
        card.className = `player-card ${player.tierClass} gpu-accelerated`;
        card.draggable = true;
        card.dataset.playerId = player.playerId;
        card.dataset.container = containerId;
        
        // Desktop drag events
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragenter', handleDragEnter);
        card.addEventListener('dragleave', handleDragLeave);
        
        // Mobile touch events
        card.addEventListener('touchstart', handleTouchStart, { passive: false });
        card.addEventListener('touchmove', handleTouchMove, { passive: false });
        card.addEventListener('touchend', handleTouchEnd);
        card.addEventListener('touchcancel', handleTouchEnd);
        
        // Click handler for viewing details
        card.addEventListener('click', (e) => {
          if (!draggedElement && !touchDragging) {
            viewPlayer(player.playerId);
          }
        });
        
        // Build stats list
        const stats = player.stats || {};
        const capBreakers = player.capBreakers || {};
        
        const statsHTML = `
          <div class="stat-row"><span class="stat-label">Face:</span><span class="stat-value">${stats.face || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Eyes:</span><span class="stat-value">${stats.eyes || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Hair:</span><span class="stat-value">${stats.hair || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Top:</span><span class="stat-value">${stats.top || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Bottom:</span><span class="stat-value">${stats.bottom || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Fitness:</span><span class="stat-value">${stats.fitness || 0}</span></div>
          <div class="stat-row"><span class="stat-label">History:</span><span class="stat-value">${stats.history || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Personal:</span><span class="stat-value">${stats.personality || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Tolerance:</span><span class="stat-value">${stats.tolerance || 0}</span></div>
          <div class="stat-row"><span class="stat-label">Substances:</span><span class="stat-value">${stats.substances || 0}</span></div>
          <div class="stat-row"><span class="stat-label">+Athletic:</span><span class="stat-value">${capBreakers.athletic || 0}</span></div>
          <div class="stat-row"><span class="stat-label">+Height:</span><span class="stat-value">${capBreakers.height || 0}</span></div>
          <div class="stat-row"><span class="stat-label">+Attract:</span><span class="stat-value">${capBreakers.attractiveness || 0}</span></div>
          <div class="stat-row"><span class="stat-label">+IntoYou:</span><span class="stat-value">${capBreakers.intoYou || 0}</span></div>
          <div class="stat-row"><span class="stat-label">+Comfort:</span><span class="stat-value">${capBreakers.comfort || 0}</span></div>
        `;
        
        card.innerHTML = `
          <div class="player-card-overall">${player.overall}</div>
          ${player.isBody ? '<div class="body-badge">üí™</div>' : ''}
          
          <div class="player-card-photo-left">
            ${player.playerPhoto 
              ? `<img src="${player.playerPhoto}" alt="${player.playerName}">`
              : 'üë§'
            }
          </div>
          
          <div class="player-card-stats-list">
            ${statsHTML}
          </div>
          
          <div class="player-card-name-bottom">${sanitizeHTML(player.playerName)}</div>
        `;
        
        container.appendChild(card);
      });
    }

    function handleDragStart(e) {
      draggedElement = e.target;
      draggedPlayerId = e.target.dataset.playerId;
      draggedContainer = e.target.dataset.container;
      
      e.target.style.opacity = '0.5';
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.innerHTML);
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      if (e.target.classList.contains('player-card')) {
        e.target.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      if (e.target.classList.contains('player-card')) {
        e.target.classList.remove('drag-over');
      }
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const targetCard = e.target.closest('.player-card');
      if (!targetCard) return false;
      
      targetCard.classList.remove('drag-over');
      
      if (draggedElement !== targetCard) {
        const targetPlayerId = targetCard.dataset.playerId;
        const targetContainer = targetCard.dataset.container;
        
        // Perform the swap/move
        swapPlayers(draggedPlayerId, targetPlayerId, draggedContainer, targetContainer);
      }
      
      return false;
    }

    function handleDragEnd(e) {
      e.target.style.opacity = '1';
      e.target.classList.remove('dragging');
      
      // Remove drag-over class from all cards
      document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('drag-over');
      });
      
      draggedElement = null;
      draggedPlayerId = null;
      draggedContainer = null;
    }

    // Touch handlers for mobile drag-and-drop
    function handleTouchStart(e) {
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      touchElement = e.currentTarget;
      
      // Long press to start dragging (300ms)
      longPressTimer = setTimeout(() => {
        if (touchElement) {
          touchDragging = true;
          touchElement.style.opacity = '0.5';
          touchElement.classList.add('dragging');
          draggedElement = touchElement;
          draggedPlayerId = touchElement.dataset.playerId;
          draggedContainer = touchElement.dataset.container;
          
          // Haptic feedback if available
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
        }
      }, 300);
    }

    function handleTouchMove(e) {
      if (!touchDragging) {
        // Check if moved too much - cancel long press
        const touch = e.touches[0];
        const deltaX = Math.abs(touch.clientX - touchStartX);
        const deltaY = Math.abs(touch.clientY - touchStartY);
        if (deltaX > 10 || deltaY > 10) {
          clearTimeout(longPressTimer);
        }
        return;
      }
      
      e.preventDefault(); // Prevent scrolling while dragging
      
      const touch = e.touches[0];
      const currentX = touch.clientX;
      const currentY = touch.clientY;
      
      // Move the card with finger
      if (touchElement) {
        touchElement.style.position = 'fixed';
        touchElement.style.left = `${currentX - 110}px`; // Center under finger
        touchElement.style.top = `${currentY - 150}px`;
        touchElement.style.zIndex = '1000';
        touchElement.style.pointerEvents = 'none';
        touchElement.style.width = '220px';
      }
      
      // Find card under touch point
      const elementUnder = document.elementFromPoint(currentX, currentY);
      const targetCard = elementUnder?.closest('.player-card');
      
      // Remove drag-over from all cards
      document.querySelectorAll('.player-card').forEach(card => {
        if (card !== touchElement) {
          card.classList.remove('drag-over');
        }
      });
      
      // Add drag-over to target
      if (targetCard && targetCard !== touchElement) {
        targetCard.classList.add('drag-over');
      }
    }

    function handleTouchEnd(e) {
      clearTimeout(longPressTimer);
      
      if (!touchDragging) {
        touchElement = null;
        return;
      }
      
      const touch = e.changedTouches[0];
      const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
      const targetCard = elementUnder?.closest('.player-card');
      
      if (touchElement) {
        touchElement.style.opacity = '1';
        touchElement.style.position = '';
        touchElement.style.left = '';
        touchElement.style.top = '';
        touchElement.style.zIndex = '';
        touchElement.style.pointerEvents = '';
        touchElement.style.width = '';
        touchElement.classList.remove('dragging');
      }
      
      document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('drag-over');
      });
      
      if (targetCard && targetCard !== touchElement && draggedPlayerId) {
        const targetPlayerId = targetCard.dataset.playerId;
        const targetContainer = targetCard.dataset.container;
        swapPlayers(draggedPlayerId, targetPlayerId, draggedContainer, targetContainer);
      }
      
      touchDragging = false;
      touchElement = null;
      draggedElement = null;
      draggedPlayerId = null;
      draggedContainer = null;
    }

    async function swapPlayers(playerId1, playerId2, container1, container2) {
      showLoading('Updating roster...');
      
      try {
        // Get current roster
        const { starters, bench } = await teamManager.getTeamRoster(teamId);
        
        let starterIds = starters.map(p => p.playerId);
        let benchIds = bench.map(p => p.playerId);
        
        // Find current positions
        const idx1Starters = starterIds.indexOf(playerId1);
        const idx1Bench = benchIds.indexOf(playerId1);
        const idx2Starters = starterIds.indexOf(playerId2);
        const idx2Bench = benchIds.indexOf(playerId2);
        
        if (container1 === container2) {
          // Same container - reorder within same list
          if (container1 === 'startersContainer') {
            // Reorder starters - calculate target index before any modifications
            const targetIdx = idx2Starters > idx1Starters ? idx2Starters - 1 : idx2Starters;
            starterIds.splice(idx1Starters, 1);
            starterIds.splice(targetIdx, 0, playerId1);
          } else {
            // Reorder bench - calculate target index before any modifications
            const targetIdx = idx2Bench > idx1Bench ? idx2Bench - 1 : idx2Bench;
            benchIds.splice(idx1Bench, 1);
            benchIds.splice(targetIdx, 0, playerId1);
          }
        } else {
          // Different containers - swap between starters and bench
          if (container1 === 'startersContainer') {
            // Player 1 from starters to bench, Player 2 from bench to starters
            starterIds.splice(idx1Starters, 1);
            benchIds.splice(idx2Bench, 1);
            starterIds.splice(idx1Starters, 0, playerId2);
            benchIds.push(playerId1); // Add to end of bench
          } else {
            // Player 1 from bench to starters, Player 2 from starters to bench
            benchIds.splice(idx1Bench, 1);
            starterIds.splice(idx2Starters, 1);
            starterIds.splice(idx2Starters, 0, playerId1);
            benchIds.push(playerId2); // Add to end of bench
          }
        }
        
        // Update roster in database
        await teamManager.updateRoster(teamId, starterIds, benchIds);
        
        hideLoading();
        showToast('Roster updated!', 'success');
        
        // Reload roster
        await loadTeamRoster();
      } catch (error) {
        hideLoading();
        console.error('Swap players error:', error);
        showToast('Failed to update roster', 'error');
      }
    }

    function addPlayer() {
      navigateToPage('player-add.html', { teamId: teamId });
    }

    function viewPlayer(playerId) {
      navigateToPage('player-card.html', { playerId: playerId });
    }

    function showTeamMenu() {
      const actions = [
        { label: 'Edit Team', action: () => navigateToPage('team-create.html', { teamId: teamId }) },
        { label: 'Share Team', action: shareTeam },
        { label: 'Delete Team', action: deleteTeam }
      ];
      
      const menu = actions.map(a => `<button class="btn btn-block" onclick="${a.action.name}()">${a.label}</button>`).join('');
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); padding: 1rem; border-radius: var(--radius-lg) var(--radius-lg) 0 0; box-shadow: var(--shadow-xl); z-index: 1000;';
      modal.innerHTML = menu + '<button class="btn btn-secondary btn-block" onclick="this.parentElement.remove()">Cancel</button>';
      document.body.appendChild(modal);
    }

    async function shareTeam() {
      if (!currentTeam) return;
      await shareData({
        title: `${currentTeam.teamName} - Hoopin'`,
        text: `Check out my team: ${currentTeam.teamName}`,
        url: window.location.href
      });
    }

    async function deleteTeam() {
      if (!currentTeam) return;
      if (!confirm(`Delete ${currentTeam.teamName}? This cannot be undone.`)) return;
      
      showLoading('Deleting team...');
      const result = await teamManager.deleteTeam(teamId);
      hideLoading();
      
      if (result.success) {
        showToast('Team deleted', 'success');
        setTimeout(() => navigateToPage('dashboard.html'), 1000);
      } else {
        showToast('Failed to delete team', 'error');
      }
    }

    window.addEventListener('load', () => {
      setupCommonElements();
      teamId = getQueryParams().teamId;
      
      if (!teamId) {
        showToast('No team specified', 'error');
        navigateToPage('dashboard.html');
        return;
      }
      
      loadTeamRoster();
    });
  </script>
</body>
</html>
