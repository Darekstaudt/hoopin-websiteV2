<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1e2d">
  <title>Add Player - Hoopin'</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/animations.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <button class="btn btn-icon" data-action="back">‚Üê Back</button>
      <div class="logo">üèÄ Hoopin'</div>
      <div style="width: 44px;"></div>
    </div>
  </header>

  <div class="container page-transition">
    <div class="form-container">
      <div class="form-card">
        <h1 class="text-center" id="formTitle">Add Player</h1>
        
        <!-- Live Calculation Display -->
        <div class="live-calculation">
          <div class="calculation-result">
            <div class="overall-display" id="overallDisplay">0</div>
            <div id="tierBadge"></div>
          </div>
          
          <div class="calculation-breakdown">
            <div class="breakdown-item">
              <div class="breakdown-label">Base Stats</div>
              <div class="breakdown-value" id="baseTotal">0</div>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-label">Cap Breakers</div>
              <div class="breakdown-value" id="capTotal">0</div>
            </div>
          </div>
        </div>

        <form id="playerForm" onsubmit="handleSubmit(event)">
          <!-- Player Name -->
          <div class="form-group required">
            <label for="playerName">Player Name</label>
            <input type="text" id="playerName" required maxlength="50">
          </div>

          <!-- Player Photo -->
          <div class="form-group">
            <label for="playerPhoto">Player Photo (Optional)</label>
            <div class="file-upload">
              <input type="file" id="playerPhoto" accept="image/*">
              <div class="file-upload-label">üì∑ Upload Photo</div>
            </div>
            <div class="file-preview" id="photoPreview">
              <img id="photoPreviewImg" alt="Player photo">
            </div>
          </div>

          <input type="hidden" id="playerPhotoData">

          <!-- Base Stats -->
          <h3>Base Stats (0-100 total)</h3>
          
          <div class="range-group">
            <div class="range-label">
              <label>Face</label>
            </div>
            <input type="range" id="face" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="faceSlider">0/100</span>
              <span class="weighted-value" id="faceWeighted">‚Üí 0.00/15</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Eyes</label>
            </div>
            <input type="range" id="eyes" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="eyesSlider">0/100</span>
              <span class="weighted-value" id="eyesWeighted">‚Üí 0.00/5</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Hair</label>
            </div>
            <input type="range" id="hair" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="hairSlider">0/100</span>
              <span class="weighted-value" id="hairWeighted">‚Üí 0.00/5</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Top</label>
            </div>
            <input type="range" id="top" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="topSlider">0/100</span>
              <span class="weighted-value" id="topWeighted">‚Üí 0.00/5</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Bottom</label>
            </div>
            <input type="range" id="bottom" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="bottomSlider">0/100</span>
              <span class="weighted-value" id="bottomWeighted">‚Üí 0.00/5</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Fitness</label>
            </div>
            <input type="range" id="fitness" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="fitnessSlider">0/100</span>
              <span class="weighted-value" id="fitnessWeighted">‚Üí 0.00/15</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>History</label>
            </div>
            <input type="range" id="history" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="historySlider">0/100</span>
              <span class="weighted-value" id="historyWeighted">‚Üí 0.00/10</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Personality</label>
            </div>
            <input type="range" id="personality" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="personalitySlider">0/100</span>
              <span class="weighted-value" id="personalityWeighted">‚Üí 0.00/20</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Tolerance</label>
            </div>
            <input type="range" id="tolerance" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="toleranceSlider">0/100</span>
              <span class="weighted-value" id="toleranceWeighted">‚Üí 0.00/10</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Substances</label>
            </div>
            <input type="range" id="substances" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="substancesSlider">0/100</span>
              <span class="weighted-value" id="substancesWeighted">‚Üí 0.00/10</span>
            </div>
          </div>

          <!-- Cap Breakers -->
          <h3 style="margin-top: 2rem;">Cap Breakers (0-9 bonus)</h3>

          <div class="range-group">
            <div class="range-label">
              <label>Athletic/Build</label>
            </div>
            <input type="range" id="athletic" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="athleticSlider">0/100</span>
              <span class="weighted-value" id="athleticWeighted">‚Üí 0.00/2</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Height</label>
            </div>
            <input type="range" id="height" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="heightSlider">0/100</span>
              <span class="weighted-value" id="heightWeighted">‚Üí 0.00/1</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Attractiveness</label>
            </div>
            <input type="range" id="attractiveness" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="attractivenessSlider">0/100</span>
              <span class="weighted-value" id="attractivenessWeighted">‚Üí 0.00/2</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Into You</label>
            </div>
            <input type="range" id="intoYou" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="intoYouSlider">0/100</span>
              <span class="weighted-value" id="intoYouWeighted">‚Üí 0.00/1</span>
            </div>
          </div>

          <div class="range-group">
            <div class="range-label">
              <label>Comfort</label>
            </div>
            <input type="range" id="comfort" min="0" max="100" value="0" oninput="updateCalculation()">
            <div class="stat-display">
              <span class="slider-value" id="comfortSlider">0/100</span>
              <span class="weighted-value" id="comfortWeighted">‚Üí 0.00/3</span>
            </div>
          </div>

          <!-- Body Toggle -->
          <div class="form-group">
            <label>Body?</label>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.75rem;">
              Does this player have a "body"? This helps determine your team's division.
            </p>
            <div class="toggle-buttons" style="display: flex; gap: 0.5rem;">
              <button 
                type="button" 
                class="toggle-btn active" 
                data-value="false"
                onclick="setBodyValue(false)"
                id="bodyNo"
                style="flex: 1; padding: 0.75rem; border-radius: var(--radius-md); border: 2px solid var(--text-secondary); background: transparent; color: var(--text-primary); cursor: pointer; transition: all 0.2s;">
                No
              </button>
              <button 
                type="button" 
                class="toggle-btn" 
                data-value="true"
                onclick="setBodyValue(true)"
                id="bodyYes"
                style="flex: 1; padding: 0.75rem; border-radius: var(--radius-md); border: 2px solid var(--text-secondary); background: transparent; color: var(--text-primary); cursor: pointer; transition: all 0.2s;">
                Yes
              </button>
            </div>
            <input type="hidden" id="isBody" name="isBody" value="false">
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">Save Player</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="autosave-indicator" id="autosaveIndicator"></div>

  <script src="js/firebase-config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/performance.js"></script>
  <script src="js/image-optimizer.js"></script>
  <script src="js/db-manager.js"></script>
  <script src="js/ratings.js"></script>
  <script src="js/groups.js"></script>
  <script src="js/teams.js"></script>
  <script src="js/players.js"></script>
  <script src="js/app.js"></script>

  <script>
    let playerPhotoBase64 = '';
    let teamId = null;
    let isEditing = false;
    let editingPlayerId = null;

    // Convert old weighted values to 0-100 slider values
    // Strategy: If value is suspiciously low for a 0-100 scale (< 50), 
    // AND is within the old weighted range, we convert it.
    // This isn't perfect but handles most real-world cases.
    function convertOldToNewScale(oldValue, maxWeight) {
      // If value is clearly in 0-100 range (> maxWeight * 2), return as is
      if (oldValue > maxWeight * 2) {
        return oldValue;
      }
      // If value is within weighted range and suspiciously low, convert it
      if (oldValue <= maxWeight) {
        return Math.round((oldValue / maxWeight) * 100);
      }
      // Otherwise return as is (assume it's already 0-100)
      return oldValue;
    }

    function setBodyValue(value) {
      document.getElementById('isBody').value = value;
      
      // Update button styles
      const noBtn = document.getElementById('bodyNo');
      const yesBtn = document.getElementById('bodyYes');
      
      if (value === true) {
        yesBtn.style.background = 'var(--accent-primary)';
        yesBtn.style.borderColor = 'var(--accent-primary)';
        noBtn.style.background = 'transparent';
        noBtn.style.borderColor = 'var(--text-secondary)';
      } else {
        noBtn.style.background = 'var(--accent-primary)';
        noBtn.style.borderColor = 'var(--accent-primary)';
        yesBtn.style.background = 'transparent';
        yesBtn.style.borderColor = 'var(--text-secondary)';
      }
    }

    function updateCalculation() {
      const baseWeights = ratingsCalculator.getBaseWeights();
      const capWeights = ratingsCalculator.getCapBreakerWeights();
      
      // Get slider values (all 0-100) and update displays
      const stats = {};
      for (const stat in baseWeights) {
        const sliderValue = parseInt(document.getElementById(stat).value);
        stats[stat] = sliderValue;
        
        // Update display with both slider value and weighted value
        const weighted = ratingsCalculator.convertToWeighted(sliderValue, baseWeights[stat]);
        document.getElementById(`${stat}Slider`).textContent = `${sliderValue}/100`;
        document.getElementById(`${stat}Weighted`).textContent = `‚Üí ${weighted.toFixed(2)}/${baseWeights[stat]}`;
      }

      const capBreakers = {};
      for (const stat in capWeights) {
        const sliderValue = parseInt(document.getElementById(stat).value);
        capBreakers[stat] = sliderValue;
        
        // Update display with both slider value and weighted value
        const weighted = ratingsCalculator.convertToWeighted(sliderValue, capWeights[stat]);
        document.getElementById(`${stat}Slider`).textContent = `${sliderValue}/100`;
        document.getElementById(`${stat}Weighted`).textContent = `‚Üí ${weighted.toFixed(2)}/${capWeights[stat]}`;
      }

      const ratings = ratingsCalculator.calculatePlayerRatings(stats, capBreakers);
      
      document.getElementById('baseTotal').textContent = ratings.baseTotal;
      document.getElementById('capTotal').textContent = ratings.capBreakerTotal;
      document.getElementById('overallDisplay').textContent = ratings.overall;
      
      const tier = ratingsCalculator.getTier(ratings.overall);
      document.getElementById('tierBadge').innerHTML = `
        <div class="tier-badge tier-${tier.class.replace('tier-', '')}" style="background: ${tier.gradient}; margin: 1rem auto; max-width: 200px;">
          <div class="tier-name">${tier.name}</div>
          <div class="tier-rarity">${tier.rarity}</div>
        </div>
      `;

      autosaveDraft();
    }

    const autosaveDraft = debounce(() => {
      const baseWeights = ratingsCalculator.getBaseWeights();
      const capWeights = ratingsCalculator.getCapBreakerWeights();
      
      const stats = {};
      for (const stat in baseWeights) {
        stats[stat] = parseInt(document.getElementById(stat).value);
      }

      const capBreakers = {};
      for (const stat in capWeights) {
        capBreakers[stat] = parseInt(document.getElementById(stat).value);
      }

      session.set('playerDraft', {
        playerName: document.getElementById('playerName').value,
        stats,
        capBreakers,
        playerPhoto: playerPhotoBase64,
        isBody: document.getElementById('isBody').value === 'true',
        teamId
      });

      const indicator = document.getElementById('autosaveIndicator');
      indicator.textContent = 'üíæ Draft saved';
      indicator.className = 'autosave-indicator saved show';
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }, 1000);

    setupImageUpload('playerPhoto', 'photoPreview', (compressed) => {
      playerPhotoBase64 = compressed;
      document.getElementById('playerPhotoData').value = compressed;
    });

    async function handleSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      
      if (!teamId) {
        showToast('No team selected', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = isEditing ? 'Updating...' : 'Saving...';
      showLoading(isEditing ? 'Updating player...' : 'Adding player...');

      try {
        const baseWeights = ratingsCalculator.getBaseWeights();
        const capWeights = ratingsCalculator.getCapBreakerWeights();
        
        const stats = {};
        for (const stat in baseWeights) {
          stats[stat] = parseInt(document.getElementById(stat).value);
        }

        const capBreakers = {};
        for (const stat in capWeights) {
          capBreakers[stat] = parseInt(document.getElementById(stat).value);
        }

        const playerData = {
          playerName: document.getElementById('playerName').value,
          playerPhoto: playerPhotoBase64,
          teamId,
          isBody: document.getElementById('isBody').value === 'true',
          stats,
          capBreakers
        };

        let result;
        if (isEditing) {
          result = await playerManager.updatePlayer(editingPlayerId, playerData);
        } else {
          result = await playerManager.createPlayer(playerData);
        }

        hideLoading();

        if (result.success) {
          showToast(isEditing ? 'Player updated!' : 'Player added!', 'success');
          session.remove('playerDraft');
          
          setTimeout(() => {
            navigateToPage('roster-view.html', { teamId: teamId });
          }, 1000);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        hideLoading();
        console.error('Submit error:', error);
        showToast(error.message || 'Failed to save player', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = isEditing ? 'Update Player' : 'Save Player';
      }
    }

    window.addEventListener('load', async () => {
      setupCommonElements();
      
      const params = getQueryParams();
      teamId = params.teamId;
      
      if (!teamId) {
        showToast('No team specified', 'error');
        setTimeout(() => navigateToPage('dashboard.html'), 2000);
        return;
      }

      if (params.playerId) {
        isEditing = true;
        editingPlayerId = params.playerId;
        document.getElementById('formTitle').textContent = 'Edit Player';
        document.getElementById('submitBtn').textContent = 'Update Player';
        
        showLoading('Loading player...');
        const player = await playerManager.getPlayer(editingPlayerId);
        hideLoading();
        
        if (player) {
          document.getElementById('playerName').value = player.playerName;
          
          const baseWeights = ratingsCalculator.getBaseWeights();
          const capWeights = ratingsCalculator.getCapBreakerWeights();
          
          // Convert old scale values to new 0-100 scale for base stats
          Object.keys(player.stats).forEach(key => {
            const oldValue = player.stats[key];
            const maxWeight = baseWeights[key];
            const newValue = convertOldToNewScale(oldValue, maxWeight);
            document.getElementById(key).value = newValue;
          });
          
          // Convert old scale values to new 0-100 scale for cap breakers
          Object.keys(player.capBreakers).forEach(key => {
            const oldValue = player.capBreakers[key];
            const maxWeight = capWeights[key];
            const newValue = convertOldToNewScale(oldValue, maxWeight);
            document.getElementById(key).value = newValue;
          });
          
          if (player.playerPhoto) {
            playerPhotoBase64 = player.playerPhoto;
            document.getElementById('photoPreviewImg').src = player.playerPhoto;
            document.getElementById('photoPreview').classList.add('show');
          }
          
          // Set body toggle
          if (player.isBody) {
            setBodyValue(true);
          } else {
            setBodyValue(false);
          }
          
          updateCalculation();
        }
      } else {
        const draft = session.get('playerDraft');
        if (draft && draft.teamId === teamId) {
          document.getElementById('playerName').value = draft.playerName || '';
          
          if (draft.stats) {
            Object.keys(draft.stats).forEach(key => {
              document.getElementById(key).value = draft.stats[key];
            });
          }
          if (draft.capBreakers) {
            Object.keys(draft.capBreakers).forEach(key => {
              document.getElementById(key).value = draft.capBreakers[key];
            });
          }
          if (draft.playerPhoto) {
            playerPhotoBase64 = draft.playerPhoto;
            document.getElementById('photoPreviewImg').src = draft.playerPhoto;
            document.getElementById('photoPreview').classList.add('show');
          }
          
          // Restore body toggle from draft
          if (draft.isBody !== undefined) {
            setBodyValue(draft.isBody);
          } else {
            setBodyValue(false);
          }
          
          updateCalculation();
        } else {
          // Initialize toggle to "No" for new players
          setBodyValue(false);
          updateCalculation();
        }
      }

      document.getElementById('playerName').addEventListener('input', autosaveDraft);
    });
  </script>
</body>
</html>
